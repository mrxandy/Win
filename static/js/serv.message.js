var Fetion={Calendar:null,Interval:null,Window:window,Action:"ajax.php",Self:{id:0,online:0,name:"猫扑大陆",active:-1,mouse:0,read:0,title:""},All:[],Groups:[],Session:[],clearHTML:function(a){a=a.replace(/^\s+|\s+$/,"").replace(/</g,"&lt;").replace(/>/g,"&gt;");return a},changeHTML:function(a){a=a.replace(/\n/g,"<br />");a=a.replace(/[ | ]*\n/g,"\n");a=a.replace(/\n[\s| | ]*\r/g,"\n");return a},filterURL:function(b){var b=b.replace(/((ftp|http|https):\/\/|www\.)([\w\/\.\?\+&#%=;,-]+)/ig,'<a href="$1$3" target="_blank">$1$3</a>');b=b.replace(/href="([^(http:\/\/)(ftp:\/\/)(https:\/\/)])/ig,'href="http://$1');return b},debug:function(b){var a="";switch(b){case"Groups":a="<table>";for(g in Fetion.Groups){a+="<tr>";for(k in Fetion.Groups[g]){a+="<td>"+Fetion.Groups[g][k]+"</td>"}a+="</tr>"}a+="</table>";break;default:alert("未知命令!");break}if(a){var c=window.open("","_blank","");c.document.open("text/html","replace");c.opener=null;c.document.write(a);c.document.close()}},Contact:function(a){var b=new Mo.Ajax(Fetion.Action);b.method="GET";b.setVar({action:"message","&execute":"contact","&me":Fetion.Self.id,"&rnd":Math.random()});b.onError=function(){alert(b.response)};b.onCompletion=function(){var h=b.responseXML;if(!h.getElementsByTagName("response")[0]){Serv.Message("连接服务器超时...","wrong");return false}var t=h.getElementsByTagName("result")[0].firstChild.data;switch(t){case"true":var f=h.getElementsByTagName("group");for(var m=0;m<f.length;m++){var r=f[m];var n=Mo.create("dl",{id:"group-"+r.getAttribute("id")});var c=Mo.create("dt",{innerHTML:r.getAttribute("name")+"<span></span>"});var s=Mo.create("dd");Mo(c).attr({gid:r.getAttribute("id")});var o=Mo.create("ul");var e=r.getElementsByTagName("admin");var l=0;for(var j=0;j<e.length;j++){var q=e[j];var d=q.getAttribute("id");var p=Mo.create("li",{title:q.firstChild.data,"data-aid":d,innerHTML:'<span class="show"></span><a href="javascript:;" onclick="Fetion.Dialog.Create( '+d+', true );"><img src="'+Serv.fix_thumb(q.getAttribute("avatar"))+'" alt="'+q.firstChild.data+'" />'+q.firstChild.data+"</a>"});Mo(o).append(p);Fetion.All[d]=[];Fetion.All[d]["aid"]=d;Fetion.All[d]["name"]=q.firstChild.data;Fetion.All[d]["avatar"]=Serv.fix_thumb(q.getAttribute("avatar"));Fetion.All[d]["group"]=q.getAttribute("group")}Mo(s).append(o);Mo(n).append(c);Mo(n).append(s);Mo("#dialog-minor").append(n);Fetion.Groups[r.getAttribute("id")]={name:r.getAttribute("name"),count:e.length}}Mo("#dialog-minor dt").each(function(u,i){var v=this.getAttribute("gid");Mo("span",this).html("("+parseInt(Fetion.Groups[v]["count"])+")")});Fetion.Dialog.Change(Fetion.Self.active);if(typeof a=="function"){a()}break;case"false":Serv.Message("获取联系人失败...","wrong");break}};b.send("")},Dialog:{Scroll:function(){if(Fetion.Self.active<0){return}var a=Fetion.Self.active;Mo.$("dialog-message").scrollTop=Mo.$("list-"+a).offsetHeight*3},Create:function(b,a){if(b==Fetion.Self.id){Serv.Message("不能和自己对话...","wrong");return false}if(Mo.Array(Fetion.Session).indexOf(b)>-1){Fetion.Dialog.Change(b);return false}Fetion.Session.push(b);Mo("#dialog-people").create("li",{id:"talk-"+b,"data-aid":b,title:Fetion.All[b]["name"],innerHTML:'<span class="hide"></span><img src="'+Fetion.All[b]["avatar"]+'" alt="'+Fetion.All[b]["name"]+'" class="avatar" /><strong>'+Fetion.All[b]["name"]+'</strong> <img onclick="Fetion.Dialog.Close('+b+');" src="image/spacer.gif" class="close" alt="关闭" />'},true).bind("click",function(){Fetion.Dialog.Change(b)});Mo("#dialog-list").create("dl",{id:"list-"+b},true).hide();if(a){Fetion.Dialog.Change(b)}Fetion.Resize()},Change:function(b){if(b<0){return}console.log("点了切换 C");Fetion.Self.active=b;console.log(Fetion.Session);for(var a in Fetion.Session){Mo("#talk-"+Fetion.Session[a]).attr({className:""});Mo("#list-"+Fetion.Session[a]).hide()}Mo("#talk-"+b).attr({className:Mo("#talk-"+b).attr("className").replace(/active/ig,"")+" active"});Mo("#list-"+b).show();Fetion.Dialog.Scroll();document.title="与 "+Fetion.All[b]["name"]+" 聊天中 - "+Fetion.Self.title;Mo("#talk-"+b+" strong").attr({className:""});Mo("#dialog-text").focus();Fetion.Dialog.getMessage()},Close:function(i,h){var c=Fetion.All[i]["name"];if(!confirm("确定要结束和 "+c+" 的聊天吗?")){return false}var d=Mo.$("talk-"+i).nextSibling;if(d){Fetion.Dialog.Change(d.getAttribute("data-aid"))}var f=Mo.$("talk-"+i).previousSibling;if(f){Fetion.Dialog.Change(f.getAttribute("data-aid"))}var b=[];for(var a in Fetion.Session){Fetion.Session[a]!=i&&b.push(Fetion.Session[a])}Fetion.Session=b;Mo("#talk-"+i).remove();Mo("#list-"+i).remove();Fetion.Resize();Mo.Event(h).stop()},getMessage:function(){var a=new Mo.Ajax(Fetion.Action);a.method="GET";a.setVar({action:"message","&execute":"reading","&sender":Fetion.Self.active,"&receiver":Fetion.Self.id,"&rnd":Math.random()});a.onError=function(){alert(a.response)};a.onCompletion=function(){var h=a.responseXML;if(!h.getElementsByTagName("response")[0]){Serv.Message("连接服务器超时...","wrong");return false}var o=h.getElementsByTagName("result")[0].firstChild.data;switch(o){case"true":var f=h.getElementsByTagName("date")[0].firstChild.data;var e=h.getElementsByTagName("time")[0].firstChild.data;var n=h.getElementById("message").getElementsByTagName("item");var c=n.length;for(var l=0;l<c;l++){var d=n[l];var m=d.firstChild.data;var b=d.getAttribute("sender");if(Mo.Array(Fetion.Session).indexOf(b)==-1){Fetion.Dialog.Create(b,false)}if(Mo.Array(Fetion.Session).indexOf(b)==0){Fetion.Dialog.Change(b)}Mo.$("list-"+b).innerHTML+="<dt>"+Fetion.All[b]["name"]+" "+e+"</dt><dd>"+Fetion.Message.Parse(m)+"</dd>";Fetion.Self.read++}if(c){Mo.Message("",c+"条新消息...",2,{unique:"sever"})}if(m){Fetion.Dialog.Scroll()}for(var l in Fetion.All){Mo("*[data-aid='"+l+"'] span").html(0).attr({className:"hide"})}var j=h.getElementById("unread").getElementsByTagName("item");for(var l=0;l<j.length;l++){Mo("*[data-aid='"+j[l].getAttribute("sender")+"'] span").html(j[l].getAttribute("stat")).attr({className:"show"})}break;case"login":Serv.Message("您当前未登录...","wrong");break}};a.send("")},checkMouse:function(){if(Fetion.Self.active<0){return}Fetion.Self.read=0;Fetion.Self.mouse=new Date().getTime();document.title="与 "+Fetion.All[Fetion.Self.active]["name"]+" 聊天中 - "+Fetion.Self.title},Title:function(){if(Fetion.Self.read>0&&new Date().getTime()-Fetion.Self.mouse>5000){setTimeout(function(){parent.document.title="【新消息】 - "+Fetion.Self.title},100);setTimeout(function(){parent.document.title="【　　　】 - "+Fetion.Self.title},300)}else{parent.document.title=Fetion.Self.title}}},Smile:{Base:Mo.store.base+"image/smile/",Display:function(c){var b="";for(var a in Fetion.Smile.Dict){b+='<img onclick="Fetion.Smile.Insert('+a+');" title="'+Fetion.Smile.Dict[a]+'" src="'+Fetion.Smile.Base+a+'.gif" />'}Mo.Tips(Mo.$("dialog-smile"),event,"tips",b,"click",45,-170,{unique:"box-smile"})},Insert:function(e){var a="["+Fetion.Smile.Dict[e]+"]";var d=Mo.$("dialog-text");if(document.selection){d.focus();sel=document.selection.createRange();sel.text=a}else{if(d.selectionStart||d.selectionStart=="0"){var c=d.selectionStart;var b=d.selectionEnd;var f=b;d.value=d.value.substring(0,c)+a+d.value.substring(b,d.value.length);f+=a.length;d.focus();d.selectionStart=f;d.selectionEnd=f}else{d.value+=a;d.focus()}}},Dict:{0:"微笑",1:"撇嘴",2:"色",3:"发呆",4:"得意",5:"流泪",6:"害羞",7:"闭嘴",8:"睡",9:"大哭",10:"尴尬",11:"发怒",12:"调皮",13:"呲牙",14:"惊讶",15:"难过",16:"酷",17:"冷汗",18:"抓狂",19:"吐",20:"偷笑",21:"可爱",22:"白眼",23:"傲慢",24:"饥饿",25:"困",26:"惊恐",27:"流汗",28:"憨笑",29:"大兵",30:"奋斗",31:"咒骂",32:"疑问",33:"嘘",34:"晕",35:"折磨",36:"衰",37:"骷髅",38:"敲打",39:"再见",40:"擦汗",41:"抠鼻",42:"鼓掌",43:"糗大了",44:"坏笑",45:"左哼哼",46:"右哼哼",47:"哈欠",48:"鄙视",49:"委屈",50:"快哭了",51:"阴险",52:"亲亲",53:"吓",54:"可怜",55:"菜刀",56:"西瓜",57:"啤酒",58:"篮球",59:"乒乓",60:"咖啡",61:"饭",62:"猪头",63:"玫瑰",64:"凋谢",65:"示爱",66:"爱心",67:"心碎",68:"蛋糕",69:"闪电",70:"炸弹",71:"刀",72:"足球",73:"瓢虫",74:"便便",75:"月亮",76:"太阳",77:"礼物",78:"拥抱",79:"强",80:"弱",81:"握手",82:"胜利",83:"抱拳",84:"勾引",85:"拳头",86:"差劲",87:"爱你",88:"NO",89:"OK",90:"爱情",91:"飞吻",92:"跳跳",93:"发抖",94:"怄火",95:"转圈",96:"磕头",97:"回头",98:"跳绳",99:"挥手",100:"激动",101:"街舞",102:"献吻",103:"左太极",104:"右太极"}},Message:{Parse:function(b){b=Fetion.clearHTML(b);b=Fetion.changeHTML(b);b=Fetion.filterURL(b);for(var a in Fetion.Smile.Dict){b=b.replace("["+Fetion.Smile.Dict[a]+"]",'<img src="'+Fetion.Smile.Base+a+'.gif" />')}return b},Send:function(){Mo("#dialog-text").focus();if(Fetion.Self.active<0){Serv.Message("请选择联系人...","wrong");return false}var b=Mo("#dialog-text").value();if(!b){Serv.Message("不能发送空消息...","wrong");return false}if(b.replace(/[^\x00-\xff]/g,"**").length>200){Serv.Message("消息内容太长...","wrong");return false}var c=Fetion.Self.active;var a=new Mo.Ajax(Fetion.Action);a.method="GET";a.setVar({action:"message","&execute":"send","&receiver":Fetion.Self.active,"&message":encodeURIComponent(b)});a.onError=function(){alert(a.response)};a.onCompletion=function(){var e=a.responseXML;Mo("#dialog-send").attr({className:""}).enabled();if(!e.getElementsByTagName("response")[0]){Serv.Message("连接服务器超时...","wrong");return false}var d=e.getElementsByTagName("result")[0].firstChild.data;switch(d){case"true":var f=e.getElementsByTagName("date")[0].firstChild.data;var h=e.getElementsByTagName("time")[0].firstChild.data;Mo("#list-"+c).html('<dt class="self">'+Fetion.Self.name+" "+h+"</dt><dd>"+Fetion.Message.Parse(b)+"</dd>",true);Mo("#dialog-text").value("").focus();Fetion.Dialog.Scroll();break;case"login":Serv.Message("您当前未登录...","wrong");break}};a.send("")},QuickSend:function(a){var a=a||window.event;if(a.ctrlKey&&a.keyCode==13){Fetion.Message.Send()}}},Resize:function(){var a=document.documentElement;var d=a.clientHeight;if(!d||d<=0){return false}var c=Mo.$("dialog-people");var f=Mo.$("dialog-tools");var b=Mo.$("dialog-textarea");var e=Mo.$("dialog-minor");Mo("#dialog-major").style({width:a.clientWidth-e.offsetWidth+"px"});Mo("#dialog-minor").style({height:d+"px"});var d=a.clientHeight-c.offsetHeight-f.offsetHeight-b.offsetHeight-20;if(d<0){d=0}Mo("#dialog-message").style({height:d+"px"})},ChatLog:{Calendar:function(c,b){var a=document.getElementById(c);if(Fetion.Calendar!=null){Fetion.Calendar.hide()}else{Fetion.Calendar=new Calendar(false,null,function(e,d){e.sel.value=d;e.hide();Fetion.ChatLog.GetXML({date:d})},function(d){d.hide()});Fetion.Calendar.setRange(1900,2070);Fetion.Calendar.create()}Fetion.Calendar.setDateFormat(b);Fetion.Calendar.parseDate(a.value);Fetion.Calendar.sel=a;Fetion.Calendar.showAtElement(a);return false},Display:function(){if(Fetion.Self.active<0){Serv.Message("请选择联系人...","wrong");return false}var c=Mo.document;var b="position:absolute;background:#666;filter:alpha(opacity=20);-moz-opacity:0.2;opacity:0.2;z-index:100; top:0;left:0;";bg=document.createElement("DIV");bg.id="chat-bg";bg.setAttribute("style",b);bg.style.cssText=b;document.body.appendChild(bg);bg.style.height=c.scrollHeight+"px";bg.style.width="100%";var a='<div id="chat-title">	<span><a href="javascript:void(0);" onclick="Mo(\'#chat-bg\').remove();Mo(\'#chat\').remove();" title="关  闭"></a></span>	<strong>与 '+Fetion.All[Fetion.Self.active]["name"]+' 的聊天记录</strong></div><div id="chat-menu">	<form action="" onsubmit="Fetion.ChatLog.GetXML({keyword:Mo.$(\'menu-keyword\').value}); return false;">	查找内容：	<input id="menu-keyword" type="text" />	<a href="javascript:void(0);" id="menu-search" onclick="Fetion.ChatLog.GetXML({keyword:Mo.$(\'menu-keyword\').value});">立即搜索</a></form>	<a href="javascript:void(0);" id="menu-export" onclick="Fetion.ChatLog.GetTXT({page:Mo.$(\'status-page\').value,date:Mo.$(\'status-date\').value,keyword:Mo.$(\'menu-keyword\').value,download:true});">导出</a>	<!--a href="#" id="menu-delete">删除</a-->	<!--a href="#" id="menu-refresh">刷新</a-->	</div><div id="chat-box">		<p>正在载入...</p></div><div id="chat-status">	<span id="chat-pages">		<a href="javascript:void(0);" id="status-first" title="最前页"><img src="image/spacer.gif" /></a>		<a href="javascript:void(0);" id="status-prev" title="上一页"><img src="image/spacer.gif" /></a>		第 <input id="status-page" type="text" size="2" onchange="Fetion.ChatLog.GetXML({page:this.value});"  /> 页/<b id="status-count">0</b>页		<a href="javascript:void(0);" id="status-next" title="下一页"><img src="image/spacer.gif" /></a>		<a href="javascript:void(0);" id="status-end" title="最后页"><img src="image/spacer.gif" /></a>	</span>	<input type="text" id="status-date" size="9" onchange="Fetion.ChatLog.GetXML({date:this.value});" />	<a href="javascript:void(0);" id="status-dalendar" onclick="return Fetion.ChatLog.Calendar(\'status-date\',\'y-mm-dd\');" title="年月日"><img src="image/spacer.gif" /></a>    </div>';obj=document.createElement("DIV");obj.id="chat";obj.innerHTML=a;document.body.appendChild(obj);obj.style.left=(c.scrollWidth/2-250)+"px";obj.style.top="50px";new Mo.Drag(Mo.$("chat-title"),obj,20,(c.scrollWidth-520),20,(c.scrollHeight-420));Fetion.ChatLog.GetXML()},Verify:function(a){if(typeof a!="object"){return}if(isNaN(parseInt(a.page))){Serv.Message("页码输入错误！","wrong");Mo("#status-page").value("");return}if(/^(\d{4})\-(\d{2})\-(\d{2})$/.test(a.date)){Serv.Message("日期输入错误！","wrong");Mo("#status-date").value("");return}},GetTXT:function(a){if(typeof a!="object"){var a={}}else{Fetion.ChatLog.Verify()}var b=Fetion.Action+"?action=message&page="+(a.page?a.page:"")+"&date="+(a.date?a.date:"")+"&keyword="+(a.keyword?encodeURI(a.keyword):"")+"&execute="+(a.download?"download":"chatlog")+"&tid="+Fetion.Self.active+"&rnd="+Math.random();Mo(document.body).create("iframe",{src:b},true).hide()},GetXML:function(a){if(typeof a!="object"){var a={}}else{Fetion.ChatLog.Verify()}Mo("#chat-box").html("<p>正在载入...</p>");var b=new Mo.Ajax(Fetion.Action);b.method="GET";b.setVar({action:"message","&execute":"chatlog","&page":(a.page?a.page:""),"&date":(a.date?a.date:""),"&keyword":(a.keyword?encodeURI(a.keyword):""),"&tid":Fetion.Self.active,"&rnd":Math.random()});b.onError=function(){alert(b.response)};b.onCompletion=function(){var h=b.responseXML;if(!h.getElementsByTagName("response")[0]){Mo("#chat-box").html("<p>连接服务器超时...</p>");return false}var s=h.getElementsByTagName("result")[0].firstChild.data;switch(s){case"true":Mo("#chat-box").html("<p>获取聊天记录成功...</p>");var m=parseInt(h.getElementsByTagName("chats")[0].getAttribute("current"));var i=parseInt(h.getElementsByTagName("chats")[0].getAttribute("pagecount"));var p=parseInt(h.getElementsByTagName("chats")[0].getAttribute("rowcount"));Mo("#status-page").value(m);Mo("#status-count").html(i);if(i==1){Mo.$("chat-pages").disabled=true}else{Mo.$("chat-pages").disabled=false;if(m==1){Mo.$("status-first").disabled=true;Mo.$("status-prev").disabled=true}else{Mo.$("status-first").disabled=false;Mo.$("status-prev").disabled=false;Mo.$("status-first").onclick=function(){Fetion.ChatLog.GetXML({page:1,keyword:a.keyword})};Mo.$("status-prev").onclick=function(){Fetion.ChatLog.GetXML({page:m-1,keyword:a.keyword})}}if(m==i){Mo.$("status-next").disabled=true;Mo.$("status-end").disabled=true}else{Mo.$("status-next").disabled=false;Mo.$("status-end").disabled=false;Mo.$("status-next").onclick=function(){Fetion.ChatLog.GetXML({page:m+1,keyword:a.keyword})};Mo.$("status-end").onclick=function(){Fetion.ChatLog.GetXML({page:i,keyword:a.keyword})}}}if(!p){var j="<p>没有找到聊天记录</p>"}else{var o=new Array();var r=h.getElementsByTagName("chat");for(var n=0;n<r.length;n++){var d=r[n].getAttribute("fname");var q=r[n].getAttribute("tname");var f=r[n].getAttribute("date");var e=r[n].getAttribute("time");var l=r[n].firstChild.data;var j="<dt "+(Fetion.All[Fetion.Self.active]["name"]==d?"":'class="self"')+">"+d+" "+e+"</dt><dd>"+Fetion.Message.Parse(l)+"</dd>";if(o[f]){o[f]+=j}else{o[f]=j}}var j="";for(x in o){j+="<div>"+x+"</div>";j+="<dl>"+o[x]+"</dl>"}}Mo("#chat-box").html(j);Mo.$("chat-box").scrollTop=Mo.$("chat-box").offsetHeight*3;break;case"false":Mo("#chat-box").html("<p>没有聊天记录...</p>");break;case"login":Mo("#chat-box").html("<p>您当前未登录...</p>");break}};b.send("")}},Start:function(){if(Mo("#dialog").size()==0){return false}Fetion.Self.title=parent.document.title;Fetion.Contact(Fetion.Dialog.getMessage);Fetion.Interval=window.setInterval(Fetion.Dialog.getMessage,10000);if(Mo.get("jump")){location.replace(Mo.get("jump"))}window.setInterval(Fetion.Dialog.Title,1000);Mo("#dialog-send").bind("click",Fetion.Message.Send);Mo("#dialog-smile").bind("click",Fetion.Smile.Display);Mo("#dialog-chat").bind("click",Fetion.ChatLog.Display);Mo("#dialog-text").bind("keydown",function(a,b){Fetion.Message.QuickSend(b);this.className="active"}).bind("click",function(){if(this.value==this.defaultValue){this.value=""}this.className="active"}).focus();if(Mo("#dialog-text").value()==Mo.$("dialog-text").defaultValue){Mo.$("dialog-text").className="active"}Mo(window).bind("resize",Fetion.Resize);Fetion.Resize();window.onbeforeunload=function(){clearInterval(Fetion.Interval)}}};Mo.reader(function(){Fetion.Start()});