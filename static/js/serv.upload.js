/*
*	(C)2009-2013 VeryIDE
*	http://www.veryide.com/
*	Serv 文件上传组件
*	$Id: serv.upload.js 2014/05/18 Lay $
*/
if(typeof Mo!="function"){var Mo={plugin:[]}}if(typeof Serv!="object"){var Serv={}}function substr_replace(c,a,d,b){if(d<0){d=d+c.length}b=b!==undefined?b:c.length;if(b<0){b=b+c.length-d}return c.slice(0,d)+a.substr(0,b)+a.slice(b)+c.slice(d+b)}Serv.fix_thumb=function(b,a){a=Mo.Validate.Array(a)?a[0]+"-"+a[1]:"thumb";return b?substr_replace(b,"-"+a+".",b.lastIndexOf("."),1):""};Serv.fix_attach=function(a){return a.replace(Mo.store.base+"attach/",Mo.store.host+"attach/")};Serv.ECode=function(a){var b={1:"上传的文件超过了服务器限制的值",2:"上传文件的大小超过了表单中 MAX_FILE_SIZE 选项指定的值",3:"文件只有部分被上传，可能为损坏文件",4:"没有文件被上传，无效或空的文件",5:"上传的文件是空的（大小为 0）",6:"找不到临时文件夹，服务器端",7:"文件写入失败，可能是没有权限"};Mo.Dialog("mo-dialog","上传提示","<p>"+b[a]+"</p>",390,0,{remove:true,draged:true,locked:true,create:true})};Serv.Multi=function(f,l,v,h){Mo.write('<textarea name="'+f+'" id="'+f+'" rows="10" style="display:none;"></textarea>');Serv.Multi.Config[f]=v;var o=v.format?"*."+v.format.join(";*.")+";":"";var q="";if(v.thumb){q+="thumb[0]="+v.thumb[0]+";";q+="thumb[1]="+v.thumb[1]+";"}var b="";if(v.crop){b+="crop[0]="+v.crop[0]+";";b+="crop[1]="+v.crop[1]+";"}var e="";for(var p in v.group){for(var m in v.group[p]){e+="group["+p+"]["+m+"]="+v.group[p][m]+";"}}var c=v.remote?v.remote:"";var a=v.session?v.session:"";var d=v.watermark?v.watermark:"";var u=v.absolute?v.absolute:"";var w=v.position?v.position:"0";var t=v.multiple?v.multiple:"0";var s=v.limit?v.limit:"1";var x=v.every?v.every:"Serv.Multi.onUpload";var j=v.finish?v.finish:"Serv.Multi.onUploadEnd";Mo.write('<embed id="'+f+'_flash" name="'+f+'_flash" src="'+Mo.store.host+"source/upload/select.swf?input=file&source="+f+"&amp;format="+o+"&amp;args=action=attach;execute=upload;model=flash;session="+a+";watermark="+d+";position="+w+";multiple="+t+";absolute="+u+";remote="+c+";"+q+e+b+"&amp;limit="+s+"&amp;size="+v.size+"&amp;every="+x+"&amp;finish="+j+"&amp;save="+Mo.store.host+'serv.php" width="430" height="25" wmode="opaque" type="application/x-shockwave-flash" AllowScriptAccess="always"></embed>');if(l){var r=l.split("||");for(var n=0;n<r.length;n++){Serv.Multi.onUpload({file:r[n]},n,f)}}};Serv.Multi.Config=[];Serv.Multi.Delete=function(a,b){if(confirm("您确认从服务器删除 "+b+" ？\n\n删除的文件将无法恢复！")){Mo("#"+a).value(Mo("#"+a).value().replace("||"+b,"").replace(b+"||","").replace(b,""));Mo("*[data-file='"+b+"']").remove();var c=new Mo.Ajax(Mo.store.host+"serv.php");c.method="GET";c.setVar({action:"attach","&execute":"delete","&file":b,"&input":"file","&rnd":Math.random()});c.onError=function(){alert(c.response)};c.onCompletion=function(){var d=c.response;switch(d){case"complete":case"file":break;case"login":parent.Mo.Alert("warning","文件上传",parent.Mo.loginBox);break;case"config":parent.Mo.Alert("warning","文件上传","您的操作已经取消！<br />您当前没有权限删除文件！");break}};c.send("")}};Serv.Multi.onUpload=function(result,current,input){result=Mo.Validate.Object(result)?result:Mo.String(result).eval();if(!result.file){Serv.ECode(result.error);return}var file=result.file;var thumb=file;var config=Serv.Multi.Config[input];if(config.thumb&&config.thumb.length){thumb=Serv.fix_thumb(file)}Mo("*[data-serv-multi='"+input+"']").create("li",{"data-file":file,className:"attach",innerHTML:'<a href="'+(config.absolute?file:Serv.fix_attach(file))+'" target="_blank"><img src="'+(config.absolute?thumb:Serv.fix_attach(thumb))+'" /></a><a class="x" onclick="Serv.Multi.onMoved(\''+input+"','"+file+"','up');\">&lt;</a><a class=\"y\" onclick=\"Serv.Multi.onMoved('"+input+"','"+file+'\',\'down\');">&gt;</a><a class="delete" href="javascript:void(0);" onclick="Serv.Multi.Delete(\''+input+"','"+file+"');\">删除</a>"});Mo.$(input).value+=(Mo.$(input).value?"||"+file:file)};Serv.Multi.onMoved=function(a,c,b){var d=Mo("*[data-file='"+c+"']").item(0);if(b=="down"){if(d.nextSibling==null){return false}else{d.swapNode(d.nextSibling)}}if(b=="up"){if(d.previousSibling==null){return false}else{d.swapNode(d.previousSibling)}}var e="";Mo("*[data-serv-multi='"+a+"'] li").each(function(){var f=this.getAttribute("data-file");e+=(e?"||"+f:f)});Mo.$(a).value=e};Serv.Multi.onUploadEnd=function(c,b,a){return"已上传 "+c+" 个，共 "+b+" 个文件"};Serv.Upload=function(c,e,d,g){var c=c;var e=e;var a=e.replace(/.*\./,"").toLowerCase();var f={};var d=d;var b=false;if(Serv.Upload.Data[c]||Mo("#"+c).size()){Mo.Dialog("mo-dialog","文件上传","<p><span class='key'>已经存在 Serv.Upload 实例: </span> </p> <p> <strong>"+c+" </strong></p>",390,0,{remove:true,draged:true,locked:true,create:true});return false}else{Serv.Upload.Data[c]={value:e,config:d,image:f,extra:a,mode:g}}switch(g){case"extra":return'<span id="'+c+'_span"></span>';break;default:Mo.write('<span id="'+c+'_span"></span>');break}if(!g){if(e){Serv.Upload.Save(c)}else{Serv.Upload.Select(c)}}};Serv.Upload.Data=new Object();Serv.Upload.Debug=false;Serv.Upload.Picture=["jpg","jpeg","gif","png","bmp"];Serv.Upload.Format=["acrobat","asp","avi","bin","bmp","chm","dll","doc","exe","fla","gzip","htm","html","ico","ini","iso","jad","jar","gif","jpg","jpeg","ms","mbk","mdb","mid","mp","msi","ms-project","msstyles","mtf","pdf","png","ppt","psd","rar","reg","rm","sis","skn","swf","tar","thm","torrent","ttc","ttf","txt","wmv","xls","xml","zip"];Serv.Upload.Short=function(a){return a.substring(a.lastIndexOf("/")+1)};Serv.Upload.Save=function(c){var e=Serv.Upload.Data[c]["size"];var h=Serv.Upload.Data[c]["image"];var d=Serv.Upload.Data[c]["config"];var a=Serv.Upload.Data[c]["extra"];var g=Serv.Upload.Data[c]["value"];Mo("#"+c+"_box").remove();if(Mo.Array(Serv.Upload.Format).indexOf(a)>-1){var f=Mo.store.host+"static/image/format/"+a+".gif"}else{var f=Mo.store.host+"static/image/icon/attach.png"}var b="";b+='<input type="hidden" name="'+c+'" id="'+c+'" value="'+g+'" /><img src="'+f+'" align="absmiddle" /> <a href="'+(d.absolute?g:Serv.fix_attach(g))+'" target="_blank">'+(d.shortname?Serv.Upload.Short(g):g)+"</a>  -  ";if(d.again){b+="<span onclick=\"javascript:Serv.Upload.New('"+c+'\');" class="upload"  title="添加新文件"><img src="'+Mo.store.host+'static/image/icon/plus.png" align="absmiddle" /> 新文件</span> - '}b+="<span onclick=\"javascript:Serv.Upload.Delete('"+c+'\');" class="upload" title="删除这个文件"><img src="'+Mo.store.host+'static/image/icon/block.png" align="absmiddle" /> 删除</span>';if(h){}Mo("#"+c+"_span").html(b);if(d.ubb){if(Mo.Array(Serv.Upload.Picture).indexOf(a)==-1){d.ubb.value+="[url]"+g+"[/url]"}else{d.ubb.value+="[img]"+g+"[/img]"}}d.callback&&d.callback(Serv.Upload.Data[c])};Serv.Upload.Editor=function(a){var b=Serv.Upload.Data[a]["value"];parent.window.__PE__=parent.Serv.Dialog("piceditor","图片",'<iframe src="resources/piceditor/?picurl='+b+'" scrolling="no" width="680" height="530"  frameborder="0"></iframe>',695,570,{minimize:true,remove:true});parent.window.__PE__.Create()};Serv.Upload.Select=function(b){var c=Serv.Upload.Data[b]["config"];var a="";if(c.input){a='<input type="text" class="text" name="'+b+'" id="'+b+'" value="" size="35" '+c.attr+" onchange=\"javascript:Serv.Upload.Change('"+b+"',this);\" /> "}else{a='<input type="hidden" name="'+b+'" id="'+b+'" value="" />'}a+='<span class="upload" id="'+b+'_btn" title="浏览并选择本地文件"><img src="'+Mo.store.host+'static/image/icon/plus.png" alt="" align="absmiddle" /> 浏览文件</span>';if(c.width&&c.width){a+=' - <span class="upload" onclick="Mo.Dialog(&quot;mo-dialog&quot;,&quot;文件上传&quot;,&quot;<p>上传图片最佳尺寸:</p><p>'+c.width+"px * "+c.height+'px </p>&quot;, 390, 0, { &quot;remove&quot; : true, &quot;locked&quot; : true, &quot;create&quot; : true } )"><img src="'+Mo.store.host+'static/image/icon/wand.png" align="absmiddle" /> '+c.width+"px * "+c.height+"px </span>"}if(c.recovery){a+=" - <span onclick=\"javascript:Serv.Upload.Back('"+b+'\');" class="upload" title="使用最近一次上传的文件"><img src="'+Mo.store.host+'static/image/icon/clock.png" align="absmiddle" /> 最近上传</span>'}a+='<iframe width="100%" height="100" frameborder="1" name="'+b+'_iframe" id="'+b+'_iframe" src="about:blank" style="display:'+(Serv.Upload.Debug?"block":"none")+';"></iframe>';if(c.format&&c.help!==false){a+=' - <span class="upload" title="查看详细上传支持格式" onclick="javascript:Mo.Dialog(&quot;mo-dialog&quot;,&quot;文件上传&quot;,&quot;<p>支持上传如下格式:</p><p>'+c.format.join(", ")+'</p>&quot;, 390, 0, { &quot;remove&quot; : true, &quot;locked&quot; : true, &quot;create&quot; : true } )"><img src="'+Mo.store.host+'static/image/icon/bubble.png" align="absmiddle" /> 支持格式</span>'}Mo("#"+b+"_span").html(a);Mo("#"+b+"_btn").bind("click",function(){Serv.Upload.Show(b)})};Serv.Upload.Change=function(a,c){var b=Serv.Upload.Data[a]["config"];b.callback&&b.callback({value:c.value,size:"",image:[],extra:""})};Serv.Upload.Hide=function(a){Mo("#"+a+"_box").hide()};Serv.Upload.Show=function(j){var c=Serv.Upload.Data[j]["config"];if(Mo("#"+j+"_box").size()){Mo("#"+j+"_box").show();return}var b=document.createElement("dl");b.id=j+"_box";b.name=j+"_box";b.className="browse";var e="";e+='<dt></dt><dd><form id="'+j+'_form" name="'+j+'_form" target="'+j+'_iframe" method="post" enctype="multipart/form-data" action="'+Mo.store.host+'serv.php"><em><img onclick="javascript:Serv.Upload.Hide(\''+j+'\');" src="'+Mo.store.host+'static/image/layout/cross.png" align="absmiddle" /></em>请选择要上传的文件：<br />';e+='<input name="action" type="hidden" value="attach" />';e+='<input name="execute" type="hidden" value="upload" />';e+='<input name="file" id="'+j+'_file" type="file" value="" style="width:210px;" />';e+='<input name="input" type="hidden" value="'+j+'" />';e+='<input name="format" type="hidden" value="'+(c.format?c.format.join(","):"")+'" />';e+='<input name="remote" type="hidden" value="'+(c.remote===false?"false":"")+'" />';e+='<input name="crop" type="hidden" value="'+(c.crop?c.crop:"0")+'" />';e+='<input name="watermark" type="hidden" value="'+(c.watermark===false?"false":"")+'" />';e+='<input name="position" type="hidden" value="'+(c.position?c.position:"0")+'" />';e+='<input name="multiple" type="hidden" value="'+(c.multiple?c.multiple:"")+'" />';e+='<input name="absolute" type="hidden" value="'+(c.absolute===true?"true":"")+'" />';e+='<input name="session" type="hidden" value="'+(c.session?c.session:"")+'" />';e+='<input name="crossdomain" type="hidden" value="'+(c.crossdomain===true?"true":"")+'" />';if(c.thumb){e+='<input name="thumb[0]" type="hidden" value="'+c.thumb[0]+'" />';e+='<input name="thumb[1]" type="hidden" value="'+c.thumb[1]+'" />'}if(c.crop){e+='<input name="crop[0]" type="hidden" value="'+c.crop[0]+'" />';e+='<input name="crop[1]" type="hidden" value="'+c.crop[1]+'" />'}for(var f in c.group){for(var d in c.group[f]){e+='<input name="group['+f+"]["+d+']" type="hidden" value="'+c.group[f][d]+'" />'}}e+="</form></dd>";b.innerHTML=e;document.body.appendChild(b);var l=Mo.document;var a=Mo.Toolkit.getScrollPosition();var i=Mo.Toolkit.getViewportSize();b.style.left=((i.width-b.offsetWidth)/2)+"px";b.style.top=a.top+((i.height-b.offsetHeight)/2)+"px";Mo("#"+j+"_file").bind("change",function(){Serv.Upload.Check(j,this)});if(Mo.Array(Mo.plugin).indexOf("drag")==-1){return false}var h=new Mo.Drag(Mo("dt",b).item(0),b,10,l.clientWidth-b.offsetWidth-10,10);h.onStart=function(g,k){b.style.filter="alpha(opacity=60)";b.style.opacity=0.6};h.onEnd=function(g,k){b.style.filter="alpha(opacity=100)";b.style.opacity=1}};Serv.Upload.Check=function(b,d){var c=Serv.Upload.Data[b]["config"];var e=d.value;var a=e.replace(/.*\./,"").toLowerCase();if(e&&a){if(c.format&&Mo.Array(c.format).indexOf(a)==-1){Mo.Dialog("mo-dialog","文件上传","<p>请选择正确的文件类型！</p> <p>支持的文件类型："+c.format.join(",")+"</p> <p>当前文件类型为："+a+"</p>",390,0,{remove:true,draged:true,locked:true,create:true});Mo("#"+b+"_form").reset()}else{Mo("#"+b+"_form").submit();Mo("#"+b+"_form").html('<img src="'+Mo.store.host+'static/image/loading.gif" /> 文件上传中，请稍后...')}}};Serv.Upload.New=function(a){if(confirm("您确认从新上传一个文件吗？\n\n现有的记录将会丢失！")){Serv.Upload.Change(a,{value:""});Serv.Upload.Select(a)}};Serv.Upload.Delete=function(a){var d=Serv.Upload.Data[a]["value"];var b=Serv.Upload.Data[a]["config"];if(confirm("您确认从服务器删除 "+d+" ？\n\n删除的文件将无法恢复！")){var c=new Mo.Ajax(Mo.store.base+"serv.php");c.method="GET";c.setVar({action:"attach","&execute":"delete","&file":d,"&input":a,"&new":b.CopyCorp,"&rnd":Math.random()});c.onError=function(){alert(c.response)};c.onCompletion=function(){var e=c.response;switch(e){case"login":Mo.Dialog("mo-dialog","文件上传","<p>您已经不在登录状态！</p>",390,0,{remove:true,draged:true,locked:true,create:true});break;case"config":Mo.Dialog("mo-dialog","文件上传","<p>您的操作已经取消！<br />您当前没有权限删除文件！</p>",390,0,{remove:true,draged:true,locked:true,create:true});break;case"complete":case"file":if(e=="file"){Mo.Dialog("mo-dialog","文件上传","<p>未找到目标文件！<br />文件是否已经通过其它方式被删除了？</p>",390,0,{remove:true,draged:true,locked:true,create:true})}Mo("#"+a).value("");Serv.Upload.Change(a,{value:""});Serv.Upload.Select(a);if(b.ubb){b.ubb.value=b.ubb.value.replace("[url]"+d+"[/url]","").replace("[img]"+d+"[/img]","")}break}};c.send("")}};Serv.Upload.Back=function(a){var b=Serv.Upload.Data[a]["config"];if(b.recovery){var c=new Mo.Ajax(Mo.store.base+"serv.php");c.method="GET";c.setVar({action:"attach","&execute":"lately","&input":a,"&rnd":Math.random()});c.onError=function(){alert(c.response)};c.onCompletion=function(){var e=c.responseXML;var d=e.getElementsByTagName("result")[0].firstChild.data;var f=e.getElementsByTagName("error")[0].firstChild.data;switch(f){case"complete":Serv.Upload.Data[a]["value"]=e.getElementsByTagName("name")[0].firstChild.data;Serv.Upload.Data[a]["size"]=e.getElementsByTagName("size")[0].firstChild.data;Serv.Upload.Data[a]["extra"]=e.getElementsByTagName("type")[0].firstChild.data;Serv.Upload.Data[a]["image"]={width:e.getElementsByTagName("width")[0].firstChild.data,height:e.getElementsByTagName("height")[0].firstChild.data};Serv.Upload.Save(a);break;case"login":Mo.Dialog("mo-dialog","文件上传","<p>您已经不在登录状态！</p>",390,0,{remove:true,draged:true,create:true});break;case"config":Mo.Dialog("mo-dialog","文件上传","<p>您的操作已经取消！<br />您当前没有权限返回文件！</p>",390,0,{remove:true,draged:true,create:true});break;case"file":Mo.Dialog("mo-dialog","文件上传","<p>未找到文件<br />在文件数据库中未找到相匹配的文件！</p>",390,0,{remove:true,draged:true,create:true});break}};c.send("")}};Serv.Upload.Done=function(a,c,b,d){Serv.Upload.Data[a]["value"]=c;Serv.Upload.Data[a]["size"]=b;Serv.Upload.Data[a]["image"]=d;Serv.Upload.Data[a]["extra"]=c.replace(/.*\./,"").toLowerCase();Serv.Upload.Save(a)};Serv.Upload.Error=function(a,c,b){Serv.ECode(c);Mo("#"+a+"_box").remove();Serv.Upload.Show(a)};Mo.plugin.push("upload");